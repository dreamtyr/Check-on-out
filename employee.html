<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>ลงเวลาทำงาน (พนักงาน)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --green-bg:#e8f5e9; --green:#1b5e20;
      --yellow-bg:#fff8e1; --yellow:#7a5e00;
      --red-bg:#ffebee; --red:#b71c1c;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:680px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 12px}
    .sub{color:var(--muted);margin-bottom:12px}
    .date{font-size:16px;margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{background:#0b1022;color:var(--text);border:1px solid #1e293b;border-radius:10px;padding:10px 12px;outline:none;width:100%}
    .col{flex:1 1 220px}
    .status{display:inline-block;border-radius:30px;padding:6px 10px;font-size:12px;margin-left:8px}
    .s-green{background:var(--green-bg);color:var(--green)}
    .s-yellow{background:var(--yellow-bg);color:var(--yellow)}
    .s-red{background:var(--red-bg);color:var(--red)}
    .btns button{border:1px solid #243045;background:#0b1022;color:#e5e7eb;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btns button:hover{transform:translateY(-1px)}
    .primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .hr{height:1px;background:#1f2937;margin:18px 0}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .foot{font-size:12px;color:#9ca3af;margin-top:10px}
    .counter{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #243045;border-radius:999px;font-size:12px;background:#0b1022}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ลงเวลาทำงาน</h1>
    <!-- ✅ เพิ่มแสดงวัน/เดือน/ปี -->
    <div class="date">วันนี้: <strong id="today"></strong></div>

    <div class="sub">กรุณากรอกรหัสพนักงาน เลือกเผ่า และอนุญาตตำแหน่ง (GPS) เพื่อเช็คอิน/เช็คเอาต์</div>

    <div class="row">
      <div class="col">
        <label>รหัสพนักงาน</label>
        <input id="empId" placeholder="เช่น 100234" inputmode="numeric" autocomplete="off">
      </div>
      <div class="col">
        <label>เผ่า</label>
        <select id="tribe">
          <option value="เผ่า 1">เผ่า 1</option>
          <option value="เผ่า 2">เผ่า 2</option>
          <option value="เผ่า 3">เผ่า 3</option>
          <option value="เผ่า 4">เผ่า 4</option>
        </select>
      </div>
    </div>

    <div class="row" style="align-items:center">
      <div>สถานะ:
        <span id="status" class="status">—</span>
      </div>
      <div id="msg" class="note"></div>
    </div>

    <!-- แสดงจำนวนครั้งที่กดพัก (วันนี้) -->
    <div class="row counter">
      <span class="note">จำนวนครั้งที่กดพัก (วันนี้):</span>
      <span class="pill">ทานข้าว: <strong id="c-lunch">0</strong></span>
      <span class="pill">สูบบุหรี่: <strong id="c-smoke">0</strong></span>
      <span class="pill">เข้าห้องน้ำ: <strong id="c-toilet">0</strong></span>
    </div>

    <div class="hr"></div>

    <div class="row btns">
      <button class="primary" onclick="send('checkin')">เข้างาน</button>
      <button onclick="send('checkout')">ออกงาน</button>
    </div>
    <div class="row btns">
      <button onclick="send('lunch')">ทานข้าว</button>
      <button onclick="send('smoke_start')">สูบบุหรี่</button>
      <button onclick="send('toilet_start')">เข้าห้องน้ำ</button>
      <button onclick="send('break_back')">กลับจากพัก</button>
    </div>

    <div class="foot">
      * ระบบจะอนุญาตให้กดปุ่มได้เมื่ออยู่ในรัศมีเผ่าของคุณ (เช่น 600 เมตร) และฝั่ง n8n จะตรวจสอบซ้ำอีกชั้น
    </div>
  </div>
</div>

<script>
  const BASE_API   = 'https://YOUR-N8N-DOMAIN';
  const API_EMP    = BASE_API + '/api/employee-event';

  // === วันที่ไทย ===
  function todayLocal(){
    const now = new Date();
    const tz = new Date(now.getTime() - now.getTimezoneOffset()*60000);
    const yyyyMmDd = tz.toISOString().slice(0,10);
    const [y,m,d] = yyyyMmDd.split('-');
    return { iso: yyyyMmDd, display:`${d}/${m}/${y}` };
  }

  // แสดงวันที่ปัจจุบัน
  document.getElementById('today').textContent = todayLocal().display;

  // ====== counter ======
  function counterKey(empId){ return `ctr:${empId}:${todayLocal().iso}`; }
  function readCounters(empId){
    try{ return JSON.parse(localStorage.getItem(counterKey(empId))) || {lunch:0,smoke:0,toilet:0}; }
    catch{ return {lunch:0,smoke:0,toilet:0}; }
  }
  function writeCounters(empId,c){ localStorage.setItem(counterKey(empId), JSON.stringify(c)); }
  function showCounters(empId,fromServer){
    let c = readCounters(empId);
    if(fromServer){
      if(typeof fromServer.LunchCount==='number') c.lunch=fromServer.LunchCount;
      if(typeof fromServer.SmokeCount==='number') c.smoke=fromServer.SmokeCount;
      if(typeof fromServer.ToiletCount==='number') c.toilet=fromServer.ToiletCount;
      writeCounters(empId,c);
    }
    document.getElementById('c-lunch').textContent=c.lunch;
    document.getElementById('c-smoke').textContent=c.smoke;
    document.getElementById('c-toilet').textContent=c.toilet;
  }

  // ====== GPS ======
  function getPos(){return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej(new Error('no gps'));
    navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),rej);
  });}
  function nowISO(){return new Date().toISOString();}
  function setStatus(color,text){
    const el=document.getElementById('status'); el.className='status';
    if(color==='green')el.classList.add('s-green');
    else if(color==='yellow')el.classList.add('s-yellow');
    else if(color==='red')el.classList.add('s-red');
    el.textContent=text||color||'—';
  }
  function setMsg(ok,text){
    const el=document.getElementById('msg'); el.className='note '+(ok?'ok':'err'); el.textContent=text||'';
  }

  // ====== send ======
  async function send(action){
    const employeeId=document.getElementById('empId').value.trim();
    const tribe=document.getElementById('tribe').value;
    if(!employeeId){setMsg(false,'กรุณากรอกรหัสพนักงาน');return;}
    if(!tribe){setMsg(false,'กรุณาเลือกเผ่า');return;}
    let pos; try{pos=await getPos();}catch{setMsg(false,'ต้องอนุญาต GPS');return;}
    setMsg(true,'กำลังส่งข้อมูล...');
    try{
      const t=todayLocal();
      const r=await fetch(API_EMP,{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({employeeId,tribe,action,lat:pos.lat,lng:pos.lng,clientTimeISO:nowISO(),dateLocal:t.iso})});
      const data=await r.json();
      if(!data.allowed){setStatus('red','นอกพื้นที่');setMsg(false,data.reason||'ไม่อนุญาต');return;}
      setStatus(data.statusColor||'',data.statusColor||'—');
      setMsg(true,data.message||'บันทึกสำเร็จ');
      const counters={LunchCount:data.row?.LunchCount,SmokeCount:data.row?.SmokeCount,ToiletCount:data.row?.ToiletCount};
      if(['lunch','smoke_start','toilet_start'].includes(action) && !Object.values(counters).some(v=>typeof v==='number')){
        const c=readCounters(employeeId);
        if(action==='lunch')c.lunch++;
        if(action==='smoke_start')c.smoke++;
        if(action==='toilet_start')c.toilet++;
        writeCounters(employeeId,c);showCounters(employeeId);
      }else showCounters(employeeId,counters);
    }catch(e){setMsg(false,'ส่งไม่สำเร็จ:'+e.message);setStatus('red','ผิดพลาด');}
  }

  document.getElementById('empId').addEventListener('input',e=>{
    const id=e.target.value.trim(); if(id)showCounters(id);
  });
</script>
</body>
</html>
