<!doctype html> 
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --green-bg:#e8f5e9; --green:#1b5e20;
      --yellow-bg:#fff8e1; --yellow:#7a5e00;
      --red-bg:#ffebee; --red:#b71c1c;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:760px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 8px}
    .date{font-size:14px;color:#cbd5e1;margin-bottom:12px}
    .sub{color:var(--muted);margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{background:#0b1022;color:var(--text);border:1px solid #1e293b;border-radius:10px;padding:10px 12px;outline:none;width:100%}
    .col{flex:1 1 220px}
    .status{display:inline-block;border-radius:30px;padding:6px 10px;font-size:12px;margin-left:8px}
    .s-green{background:var(--green-bg);color:var(--green)}
    .s-yellow{background:var(--yellow-bg);color:var(--yellow)}
    .s-red{background:var(--red-bg);color:var(--red)}
    .btns button{border:1px solid #243045;background:#0b1022;color:#e5e7eb;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btns button:hover{transform:translateY(-1px)}
    .primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .hr{height:1px;background:#1f2937;margin:18px 0}
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .foot{font-size:12px;color:#9ca3af;margin-top:10px}
    .counter{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #243045;border-radius:999px;font-size:12px;background:#0b1022}
    .timer{margin-top:8px;font-size:13px;color:#c7d2fe}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h1>
    <div class="date">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <strong id="today">--/--/----</strong></div>
    <div class="sub">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå</div>

    <div class="row">
      <div class="col">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input id="empId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100234" inputmode="numeric" autocomplete="off">
      </div>
      <div class="col">
        <label>‡πÄ‡∏ú‡πà‡∏≤</label>
        <select id="tribe">
          <option value="‡πÄ‡∏ú‡πà‡∏≤ 1">‡πÄ‡∏ú‡πà‡∏≤ 1</option>
          <option value="‡πÄ‡∏ú‡πà‡∏≤ 2">‡πÄ‡∏ú‡πà‡∏≤ 2</option>
          <option value="‡πÄ‡∏ú‡πà‡∏≤ 3">‡πÄ‡∏ú‡πà‡∏≤ 3</option>
          <option value="‡πÄ‡∏ú‡πà‡∏≤ 4">‡πÄ‡∏ú‡πà‡∏≤ 4</option>
        </select>
      </div>
    </div>

    <div class="row" style="align-items:center">
      <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status" class="status">‚Äî</span></div>
      <div id="msg" class="note"></div>
    </div>

    <!-- ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
    <div class="row counter">
      <span class="note">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏û‡∏±‡∏Å (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ):</span>
      <span class="pill">‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß: <strong id="c-lunch">0</strong></span>
      <span class="pill">‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà: <strong id="c-smoke">0</strong></span>
      <span class="pill">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥: <strong id="c-toilet">0</strong></span>
    </div>
    <div id="breakTimer" class="timer"></div>

    <div class="hr"></div>

    <div class="row btns">
      <button class="primary" onclick="send('checkin')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
      <button onclick="send('checkout')">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
    </div>
    <div class="row btns">
      <button onclick="send('lunch')">‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß</button>
      <button onclick="send('smoke_start')">‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà</button>
      <button onclick="send('toilet_start')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥</button>
      <button onclick="send('break_back')">‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏Å</button>
    </div>

    <div class="foot">
      * ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤: ‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏î‡πâ 60 ‡∏ô‡∏≤‡∏ó‡∏µ / ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‚Äì‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥ 20 ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏Å = ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢)
    </div>
  </div>
</div>

<script>
  /* ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Webhook ‡∏Ç‡∏≠‡∏á n8n ======
     üëâ ‡πÄ‡∏≠‡∏≤ URL ‡∏à‡∏≤‡∏Å Node Webhook (Production URL) ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
  const WEBHOOK_URL = 'http://localhost:5678/webhook/PUT-YOUR-WEBHOOK-ID-HERE';

  /* ===== USER FROM LOGIN (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ===== */
  let CURRENT_USER = null;
  try { CURRENT_USER = JSON.parse(localStorage.getItem('currentUser')||'null'); } catch {}

  /* ===== Date ===== */
  function todayLocal(){
    const now = new Date();
    const tz  = new Date(now.getTime()-now.getTimezoneOffset()*60000);
    const ymd = tz.toISOString().slice(0,10);
    const [y,m,d]=ymd.split('-');
    return {iso:ymd, display:`${d}/${m}/${y}`};
  }
  document.getElementById('today').textContent = todayLocal().display;

  /* ===== Prefill from login ===== */
  if(CURRENT_USER){
    document.getElementById('empId').value = CURRENT_USER.id||'';
    if(CURRENT_USER.tribe){
      const t=`‡πÄ‡∏ú‡πà‡∏≤ ${CURRENT_USER.tribe}`;
      for(const op of document.getElementById('tribe').options){
        if(op.value===t) document.getElementById('tribe').value=t;
      }
    }
  }

  /* ===== Counter (per day) ===== */
  function key(emp){return `ctr:${emp}:${todayLocal().iso}`;}
  function readCtr(emp){try{return JSON.parse(localStorage.getItem(key(emp)))||{lunch:0,smoke:0,toilet:0}}catch{return {lunch:0,smoke:0,toilet:0}}}
  function writeCtr(emp,c){try{localStorage.setItem(key(emp), JSON.stringify(c))}catch{}}
  function renderCtr(emp,fromServer){
    let c = readCtr(emp);
    if(fromServer){
      if(typeof fromServer.LunchCount  === 'number') c.lunch  = fromServer.LunchCount;
      if(typeof fromServer.SmokeCount  === 'number') c.smoke  = fromServer.SmokeCount;
      if(typeof fromServer.ToiletCount === 'number') c.toilet = fromServer.ToiletCount;
      writeCtr(emp,c);
    }
    document.getElementById('c-lunch').textContent  = c.lunch;
    document.getElementById('c-smoke').textContent  = c.smoke;
    document.getElementById('c-toilet').textContent = c.toilet;
  }
  document.getElementById('empId').addEventListener('input',e=>{
    const id=e.target.value.trim(); if(id) renderCtr(id);
  });

  /* ===== Status / Message ===== */
  function setStatus(color,text){
    const el=document.getElementById('status'); el.className='status';
    if(color==='green') el.classList.add('s-green');
    else if(color==='yellow') el.classList.add('s-yellow');
    else if(color==='red') el.classList.add('s-red');
    el.textContent=text||color||'‚Äî';
  }
  function setMsg(ok,text){
    const el=document.getElementById('msg'); el.className='note '+(ok?'ok':'err'); el.textContent=text||'';
  }

  /* ===== GPS ===== */
  function getPos(){return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej(new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS'));
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
      rej,
      {enableHighAccuracy:true,timeout:15000}
    );
  })}

  /* ===== Break Timer (client reminder 60/20) ===== */
  let breakDeadline = 0, breakTicker=null, breakType='';
  function startBreakTimer(type){
    clearInterval(breakTicker);
    breakType = type;
    const limitMin = (type==='lunch')?60:20; // ‚úÖ ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    breakDeadline = Date.now() + limitMin*60*1000;
    const box = document.getElementById('breakTimer');
    const paint = ()=>{
      const remain = Math.max(0, breakDeadline - Date.now());
      const mm = Math.floor(remain/60000), ss=Math.floor((remain%60000)/1000);
      box.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å (${type==='lunch'?'‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 60 ‡∏ô‡∏≤‡∏ó‡∏µ':'20 ‡∏ô‡∏≤‡∏ó‡∏µ'}): ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
      if(remain<=0){
        clearInterval(breakTicker);
        alert('‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏Å"');
        box.textContent='‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
      }
    };
    paint();
    breakTicker = setInterval(paint, 1000);
  }
  function stopBreakTimer(){
    clearInterval(breakTicker);
    breakTicker=null; breakDeadline=0; breakType='';
    document.getElementById('breakTimer').textContent='';
  }

  /* ===== SEND EVENT ===== */
  function nowISO(){return new Date().toISOString();}
  async function send(action){
    const employeeId=(document.getElementById('empId').value||'').trim();
    const tribe=document.getElementById('tribe').value;
    if(!employeeId){ setMsg(false,'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
    if(!tribe){ setMsg(false,'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ú‡πà‡∏≤'); return; }

    setMsg(true,'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶');
    let pos; try{ pos = await getPos(); }catch(e){ setMsg(false,'‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS)'); return; }

    setMsg(true,'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶');
    try{
      const payload={
        employeeId, tribe, action,
        lat:pos.lat, lng:pos.lng,
        clientTimeISO: nowISO(),
        dateLocal: todayLocal().iso,
        actorRole:'employee', actorId:employeeId
      };

      const r = await fetch(WEBHOOK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=>({}));

      if(!r.ok || (data && data.allowed===false)){
        setStatus('red','‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï');
        setMsg(false, (data && data.reason) ? data.reason : '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      setStatus(data?.statusColor||'', data?.statusColor||'‚Äî');
      setMsg(true, data?.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á client ‡∏ñ‡πâ‡∏≤ server ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á count ‡∏Å‡∏•‡∏±‡∏ö
      const srv={LunchCount:data?.row?.LunchCount, SmokeCount:data?.row?.SmokeCount, ToiletCount:data?.row?.ToiletCount};
      if(['lunch','smoke_start','toilet_start'].includes(action) &&
         !Object.values(srv).some(v=>typeof v==='number')){
        const c = readCtr(employeeId);
        if(action==='lunch') c.lunch++;
        if(action==='smoke_start') c.smoke++;
        if(action==='toilet_start') c.toilet++;
        writeCtr(employeeId,c); renderCtr(employeeId);
      }else{
        renderCtr(employeeId,srv);
      }

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ù‡∏±‡πà‡∏á client
      if(['lunch','smoke_start','toilet_start'].includes(action)) startBreakTimer(action);
      if(action==='break_back' || action==='checkout') stopBreakTimer();

    }catch(e){
      setMsg(false,'‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e));
      setStatus('red','‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    }
  }

  // ‡πÅ‡∏™‡∏î‡∏á counter ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î
  (function init(){
    const id = document.getElementById('empId').value.trim();
    if(id) renderCtr(id);
  })();
</script>
</body>
</html>
