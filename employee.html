<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>ลงเวลาทำงาน (พนักงาน)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ลงเวลาทำงาน</h1>
    <div class="sub">วันที่ <b id="today">--/--/----</b> • ผู้ใช้: <b id="who">—</b></div>

    <div class="row">
      <div style="flex:1 1 220px">
        <label>รหัสพนักงาน</label>
        <input id="empId" readonly>
      </div>
      <div style="flex:1 1 220px">
        <label>เผ่า (ล็อกเฉพาะวันนี้)</label>
        <input id="tribe" readonly>
      </div>
    </div>

    <div class="row" style="align-items:center;margin-top:8px">
      <div>สถานะ: <span id="status" class="status">—</span></div>
      <div id="msg" class="note"></div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button class="btn btnPrimary" onclick="send('checkin')">เข้างาน</button>
      <button class="btn" onclick="send('checkout')">ออกงาน</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="send('lunch')">ทานข้าว</button>
      <button class="btn" onclick="send('smoke_start')">สูบบุหรี่</button>
      <button class="btn" onclick="send('toilet_start')">เข้าห้องน้ำ</button>
      <button class="btn btnPrimary" onclick="send('break_back')">กลับจากพัก</button>
    </div>

    <div class="footer">* เงื่อนไขเวลา: ข้าว 60 นาที / สูบบุหรี่-ห้องน้ำ 20 นาที</div>
  </div>
</div>

<script src="common.js"></script>
<script>
document.getElementById('today').textContent = todayLocal().display;
const u = getCurrentUser();
if(!u){ alert('กรุณาเข้าสู่ระบบ'); location.href='index.html'; }
document.getElementById('who').textContent = `${u?.name||''} (${u?.id||''})`;

const locked = getLockedTribe(u.id, todayLocal().iso);
if(!locked && u.role==='employee'){
  alert('ยังไม่เลือกเผ่าวันนี้ กรุณากลับไปล็อกอินเพื่อเลือกเผ่า');
  location.href='index.html';
}
document.getElementById('empId').value = u.id || '';
document.getElementById('tribe').value = locked? `เผ่า ${locked}` : (u.role==='manager'?'— (ผู้จัดการ)':'—');

function setStatus(color,text){
  const el=document.getElementById('status'); el.className='status';
  if(color==='green') el.classList.add('s-green');
  else if(color==='yellow') el.classList.add('s-yellow');
  else if(color==='red') el.classList.add('s-red');
  el.textContent=text||color||'—';
}
function setMsg(ok,text){
  const el=document.getElementById('msg'); el.style.color=ok?'#86efac':'#fca5a5'; el.textContent=text||'';
}

async function send(action){
  const employeeId = u.id;
  const tribe = locked ? `เผ่า ${locked}` : (u.role==='manager'?'':'');
  if(!employeeId){ setMsg(false,'ไม่พบรหัส'); return; }
  setMsg(true,'กำลังขอตำแหน่ง…');
  let pos; try{ pos = await getPos(); }catch(e){ setMsg(false,'ต้องอนุญาต GPS'); return; }
  setMsg(true,'กำลังส่งข้อมูล…');
  try{
    const payload = {
      employeeId, tribe, action,
      lat:pos.lat, lng:pos.lng,
      clientTimeISO: nowISO(),
      dateLocal: todayLocal().iso,
      actorRole: 'employee', actorId: employeeId
    };
    const data = await postJSON(API.EMP_EVENT, payload);
    if(data?.allowed===false){ setStatus('red','ไม่อนุญาต'); setMsg(false, data?.reason||'ถูกปฏิเสธ'); return; }
    setStatus(data?.statusColor||'', data?.statusColor||'—');
    setMsg(true, data?.message||'บันทึกสำเร็จ');
  }catch(e){
    setStatus('red','ผิดพลาด'); setMsg(false, e.message||e);
  }
}
</script>
</body>
</html>
