<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>เข้าสู่ระบบ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--blue:#2563eb;--border:#e5e7eb}
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f8fafc}
    .wrap{max-width:560px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:20px}
    h1{margin:0 0 8px}
    .sub{color:#475569;margin-bottom:16px}
    label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
    input{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    .row{display:flex;gap:10px;align-items:flex-end;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .btnPrimary{background:var(--blue);border:none;color:#fff}
    .note{margin-top:8px;color:#ef4444}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>เข้าสู่ระบบ</h1>
    <div class="sub">กรุณากรอกรหัสพนักงาน ระบบจะตรวจบทบาท (พนักงาน/หัวหน้า) จาก n8n</div>

    <label>รหัสพนักงาน</label>
    <input id="emp" placeholder="เช่น 100234" inputmode="numeric" autocomplete="off">

    <div class="row">
      <button class="btn btnPrimary" onclick="login()">เข้าสู่ระบบ</button>
      <button class="btn" onclick="demo()">กรอกตัวอย่าง</button>
    </div>
    <div id="msg" class="note"></div>
  </div>
</div>

<script>
  const BASE_API   = 'https://YOUR-N8N-DOMAIN';                    // TODO
  const API_LOOKUP = BASE_API + '/api/lookup-employee';            // ?employeeId=&date=YYYY-MM-DD

  function todayISO(){
    const now=new Date(); const tz=new Date(now.getTime()-now.getTimezoneOffset()*60000);
    return tz.toISOString().slice(0,10);
  }
  function demo(){ document.getElementById('emp').value='100234'; }

  async function login(){
    const id=(document.getElementById('emp').value||'').trim();
    const msg=document.getElementById('msg');
    if(!id){ msg.textContent='กรุณากรอกรหัส'; return; }
    msg.textContent='กำลังตรวจสอบ...';
    try{
      const r=await fetch(`${API_LOOKUP}?employeeId=${encodeURIComponent(id)}&date=${todayISO()}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data=await r.json(); // {role,name,tribe,managedTribes?,assignedTribes?}
      const user={
        id:id,
        name:data.name||'',
        role:(data.role||'employee'),
        tribe:(data.tribe||''),
        managedTribes:Array.isArray(data.managedTribes)?data.managedTribes:[],
        assignedTribes:Array.isArray(data.assignedTribes)?data.assignedTribes:[]
      };
      localStorage.setItem('currentUser', JSON.stringify(user));
      // ไปหน้า role
      if(user.role==='manager') location.href='manager.html';
      else location.href='employee.html';
    }catch(e){
      msg.textContent='ล็อกอินไม่สำเร็จ: '+(e.message||e);
    }
  }
</script>
</body>
</html>
